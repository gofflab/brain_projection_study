---
title: "Projection_imputed_energy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(NNLM)
library(rgl)
library(dplyr)
library(Seurat)
library(projectR)
library(magick)
library(plotrix)
library(viridisLite)
source("/Users/25149/Documents/JHU/Rotation/Dr.Goff/new_dev_v3/conserved pattern/EvaluateProjection.R")
source("/Users/25149/Documents/JHU/Rotation/Dr.Goff/new_dev_v3/conserved pattern/myColorRamp.R")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r data prepare}
load("/Users/25149/Documents/JHU/Rotation/Dr.Goff/new_dev_v3/imputation/CoGAPS/Energy_imputed_CoGAPS120.RData")
load("/Users/25149/Documents/JHU/Rotation/Dr.Goff/new_dev_v3/conserved pattern/group.RData")
load("/Users/25149/Documents/JHU/Rotation/Dr.Goff/new_dev_v3/p56coord_dev_v3_left.RData")

xlim=c(0,max(coord_annotation_dev_v3_left))
ylim=xlim
zlim=ylim
```

```{r}
## read in normalized data -visual cortex
projected_data_norm<-read.csv("/Users/25149/Documents/JHU/Rotation/Dr.Goff/projection/visual cortex/GSE71585_RefSeq_TPM.csv")
visual_genes<-projected_data_norm[,1]
names(visual_genes)<-NULL
projected_data_norm<-data.matrix(projected_data_norm[,-1])
rownames(projected_data_norm)<-visual_genes

## projectR-CoGAPS

visual_projection<-projectR(projected_data_norm,loadings = Energy_imputed_CoGAPS120@featureLoadings[,imputed_p120k9],full=TRUE)

## poltting random cell-CoGAPS
random_cell<-sample(1:ncol(visual_projection$projection),1)
random_cell_name<-colnames(visual_projection$projection)[random_cell]

open3d()
par3d(windowRect = c(20, 30, 1200, 1200))
cor<-cor(t(Energy_imputed_CoGAPS120@sampleFactors[,imputed_p120k9]),visual_projection$projection[,random_cell])
plot3d(coord_annotation_dev_v3_left,col=myColorRamp(inferno(100),cor),size=3,box=F,axes=F,xlab="",ylab="", zlab="",xlim=xlim,ylim=ylim,zlim=zlim, main=random_cell_name, alpha=(cor-min(cor))/(max(cor)-min(cor)))

bgplot3d( suppressWarnings (fields::image.plot( legend.only=TRUE, nlevel=100,zlim=c(min(cor),max(cor)), legend.args=list(text=''),col=inferno(100))))

## Evaluation
e1<-EvaluateProjection(visual_projection$projection,t(Energy_imputed_CoGAPS120@sampleFactors[,imputed_p120k9]),group,allzero = c())
summary(as.factor(e1))
```
```{r}
## load stratium data
stratium<-read.csv(file = "/Users/25149/Documents/JHU/Rotation/Dr.Goff/projection/stratium/GSE82187_cast_all_forGEO.csv")
stratium_genes<-colnames(stratium)[-(1:5)]
stratium<-t(stratium[,-(1:5)])%>%as.matrix()

##projectR-CoGAPS
stratium_projection<-projectR(stratium,loadings=Energy_imputed_CoGAPS120@featureLoadings[,imputed_p120k9],full=TRUE)

## plotting random cell-CoGAPS
random_cell<-sample(1:ncol(stratium_projection$projection),1)
random_cell_name<-colnames(stratium_projection$projection)[random_cell]

open3d()
par3d(windowRect = c(20, 30, 1200, 1200))
cor<-cor(t(Energy_imputed_CoGAPS120@sampleFactors[,imputed_p120k9]),stratium_projection$projection[,random_cell])
plot3d(coord_annotation_dev_v3_left,col=myColorRamp(inferno(100),cor),size=3,box=F,axes=F,xlab="",ylab="",zlab="",xlim=xlim,ylim=ylim,zlim=zlim, main=random_cell_name,alpha=(cor-min(cor))/(max(cor)-min(cor)))

bgplot3d( suppressWarnings (fields::image.plot( legend.only=TRUE, nlevel=100,zlim=c(min(cor),max(cor)), legend.args=list(text=''),col=inferno(100))))

e1<-EvaluateProjection(stratium_projection$projection,t(Energy_imputed_CoGAPS120@sampleFactors[,imputed_p120k9]),group,allzero = c())
summary(as.factor(e1))
```

